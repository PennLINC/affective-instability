anatomical: []
name: pafin_scalar_maps
description: |
    pafin_scalar_maps is the pipeline used by the PAFIN dataset
    to produce a range of scalar maps from diffusion MRI data, based on the HBCD pipeline [@cieslak2025diffusion].
space: T1w
nodes:

# Extrapolate to ABCD's sampling scheme
-   action: 3dSHORE_reconstruction
    input: qsirecon
    name: extrapolate_abcd
    parameters:
        big_delta: 0.01973
        extrapolate_scheme: ABCD
        lambdaL: 1.0e-08
        lambdaN: 1.0e-08
        radial_order: 8
        regularization: L2
        small_delta: 0.04302
        write_fibgz: false
        write_mif: false
    software: Dipy
    qsirecon_suffix: extrapolateABCD

-   action: DKI_reconstruction
    input: extrapolate_abcd
    name: dipy_dki
    parameters:
        # Calculate microstructural metrics
        wmti: false
        write_fibgz: false
        write_mif: false
    qsirecon_suffix: DIPYDKI
    software: Dipy

-   action: estimate
    input: extrapolate_abcd
    name: tortoise_dtmapmri
    parameters:
        big_delta: 0.01973
        estimate_mapmri:
            map_order: 4
        estimate_tensor:
            bval_cutoff: 1200
            write_cs: true
        estimate_tensor_separately: true
        small_delta: 0.04302
    qsirecon_suffix: TORTOISE_model-MAPMRI
    software: TORTOISE

-   action: estimate
    input: extrapolate_abcd
    name: tortoise_fullshell_tensor
    parameters:
        big_delta: 0.01973
        estimate_tensor:
            bval_cutoff: 4000
            write_cs: true
        estimate_tensor_separately: true
        small_delta: 0.04302
    qsirecon_suffix: TORTOISE_model-tensor
    software: TORTOISE

-   action: reconstruction
    input: extrapolate_abcd
    name: dsistudio_gqi
    parameters:
        method: gqi
    qsirecon_suffix: DSIStudio
    software: DSI Studio

-   action: fit_noddi
    input: extrapolate_abcd
    name: fit_noddi
    parameters:
        dIso: 0.003
        dPar: 0.0017
        isExvivo: false
    qsirecon_suffix: wmNODDI
    software: AMICO

-   action: fit_noddi
    input: extrapolate_abcd
    name: fit_noddi_gm
    parameters:
        dIso: 0.003
        dPar: 0.0011
        isExvivo: false
    qsirecon_suffix: gmNODDI
    software: AMICO

-   action: autotrack
    input: dsistudio_gqi
    name: autotrackgqi
    parameters:
        tolerance: 22,26,30
        track_id: Association,Projection,Commissure,Cerebellum
        track_voxel_ratio: 2.0
        yield_rate: 1.0e-06

    qsirecon_suffix: DSIStudio
    software: DSI Studio

-   action: export
    input: dsistudio_gqi
    name: gqi_scalars
    qsirecon_suffix: DSIStudio
    software: DSI Studio

-   action: bundle_map
    input: autotrackgqi
    name: bundle_means
    scalars_from:
    - gqi_scalars
    - dipy_dki
    - tortoise_fullshell_tensor
    - tortoise_dtmapmri
    software: qsirecon

-   action: template_map
    input: qsirecon
    name: template_map
    parameters:
        interpolation: NearestNeighbor
    scalars_from:
    - gqi_scalars
    - dipy_dki
    - tortoise_fullshell_tensor
    - tortoise_dtmapmri
    software: qsirecon
